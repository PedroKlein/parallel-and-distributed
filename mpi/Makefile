# --- Configurable Variables ---
# Default values that can be overridden on the command line.
# Ex: make run NP=8 N=1024 COMM_TYPE=async

# Number of MPI Processes
NP ?= 4
# Matrix Size
N ?= 2048
# Communication Type (collective, sync, async, async_naive)
COMM_TYPE ?= collective
# Python interpreter command
PYTHON = python3
# Path to the executable
EXECUTABLE = build/mpi_matmult


# --- Targets ---

# .PHONY declares that these targets do not produce files with the same name.
# This ensures they always execute their associated commands.
.PHONY: all build run validate test clean help

# The 'all' target is the default. If you just type 'make', it will be executed.
all: build

# Compiles the project using mpicc.
# Depends on source files and headers.
# If none of these files changed, compilation will not be redone.
build: $(EXECUTABLE)

$(EXECUTABLE): src/*.c include/*.h
	mkdir -p build
	@echo "--- [BUILD] Compiling the project with mpicc ---"
	mpicc -O2 -Iinclude -o $(EXECUTABLE) src/*.c
	@echo "--- [BUILD] Compilation finished: $(EXECUTABLE) ---"

# Runs a single instance of the program with the defined parameters.
run: build
	@echo "--- [RUN] Running with NP=$(NP), N=$(N), Type=$(COMM_TYPE) ---"
	@mpirun -np $(NP) $(EXECUTABLE) $(N) $(COMM_TYPE)

# Runs the program with the validation flag.
validate: build
	@echo "--- [VALIDATE] Running with VALIDATION (NP=$(NP), N=$(N), Type=$(COMM_TYPE)) ---"
	@mpirun -np $(NP) $(EXECUTABLE) $(N) $(COMM_TYPE) --validate
	@echo "--- [VALIDATE] Validation finished. ---"

# Runs the Python script for batch testing.
test: build
	@echo "--- [TEST] Starting batch test script ---"
	@$(PYTHON) scripts/batch_test.py $(EXECUTABLE)
	@echo "--- [TEST] Test script finished. ---"

# Cleans the project, removing the build directory and results.
clean:
	@echo "--- [CLEAN] Removing build directory and result files ---"
	@rm -rf build mpi_results.csv
	@echo "--- [CLEAN] Clean finished. ---"


run-batch:
	sbatch hype.slurm

get-status:
	@echo "--- [STATUS] Checking the status of the last batch job ---"
	@squeue -u $$(whoami)

cancel-batch:
	@echo "--- [CANCEL] Cancelling the last batch job ---"
	@scancel $$(squeue -u $$(whoami) -h -o "%A" | head -n 1)

# Run the MPI application in the Docker Compose cluster
run-docker: build
	@echo "--- [DOCKER] Running MPI in Docker Compose cluster ---"
	@docker-compose exec main mpirun --allow-run-as-root -np $(NP) -host main,node1,node2,node3 /workspace/build/mpi_matmult $(N) $(COMM_TYPE)

# Run the batch test in the Docker Compose cluster
batch-test-docker: build
	@echo "--- [DOCKER] Running batch test in Docker Compose cluster ---"
	@docker-compose exec main python3 /workspace/scripts/batch_test.py /workspace/build/mpi_matmult

# Start the Docker SLURM cluster
start-docker-cluster:
	docker-compose up -d --build

# Stop the Docker SLURM cluster
stop-docker-cluster:
	docker-compose down

# SSH into the master node (default password: root)
ssh-master:
	ssh root@localhost -p 2222

# Submit a SLURM batch job from inside the master node
submit-job:
	ssh root@localhost -p 2222 "sbatch /workspace/hype.slurm"

# Show SLURM queue status from master
slurm-status:
	ssh root@localhost -p 2222 "squeue -u root"

# Cancel the last SLURM job from master
slurm-cancel:
	ssh root@localhost -p 2222 "scancel \$(squeue -u root -h -o '%A' | head -n 1)"

# A help target to display available commands.
help:
	@echo "Makefile for the MPI Matrix Multiplication Project"
	@echo ""
	@echo "Usage:"
	@echo "  make build          - Compiles the source code (default)."
	@echo "  make run            - Runs a single instance of the program."
	@echo "  make validate       - Runs a single instance with result validation."
	@echo "  make test           - Runs the full batch test suite with the Python script."
	@echo "  make clean          - Removes all files generated by compilation and tests."
	@echo ""
	@echo "You can override variables for 'run' and 'validate':"
	@echo "  make validate NP=2 N=128 COMM_TYPE=async"
	@echo ""